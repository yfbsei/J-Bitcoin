# Bech32 Address Encoding (BIP173/BIP350)

Comprehensive Bech32 and Bech32m address encoding implementation following BIP173 and BIP350 specifications.

## Description

This module provides complete Bech32 address encoding and decoding functionality for Bitcoin SegWit addresses. It supports both Bech32 (for version 0 witness programs) and Bech32m (for version 1+ witness programs including Taproot) with comprehensive validation, security features, and official test vector compliance.

## Example

```javascript
import { BECH32 } from 'j-bitcoin';

// Encode Bech32 address (version 0 - SegWit)
const prefix = "bc";
const witnessVersion = 0;
const witnessProgram = Buffer.from("751e76e8199196d454941c45d1b3a323f1433bd6", "hex");

// Convert to 5-bit groups for encoding
const data = [witnessVersion, ...convertTo5Bit(witnessProgram)];
const address = BECH32.encode(prefix, data, 'bech32');
console.log('SegWit Address:', address);
// Output: bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4

// Encode Bech32m address (version 1+ - Taproot)
const taprootData = [1, ...convertTo5Bit(witnessProgram)];
const taprootAddress = BECH32.encode(prefix, taprootData, 'bech32m');
console.log('Taproot Address:', taprootAddress);

// Decode any Bech32 address
const decoded = BECH32.decode("bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4");
console.log('HRP:', decoded.hrp);           // "bc"
console.log('Data:', decoded.data);         // [0, 14, 20, 15, ...]
console.log('Encoding:', decoded.encoding); // "bech32"

// Validate address format and checksum
const isValid = BECH32.isValidAddress(address);
console.log('Valid:', isValid); // true

// Convert hex data directly to Bech32
const hexData = "0014751e76e8199196d454941c45d1b3a323f1433bd6";
const directAddress = BECH32.data_to_bech32("bc", hexData);
console.log('Direct conversion:', directAddress);

// Testnet example
const testnetAddress = BECH32.encode("tb", data, 'bech32');
console.log('Testnet Address:', testnetAddress);
```

## API Reference

### Static Methods

#### `BECH32.encode(prefix, data, encoding = 'bech32')`
Encodes data into a Bech32 or Bech32m address.

**Parameters:**
- `prefix` (string) - Human-readable prefix ("bc", "tb", etc.)
- `data` (Array|Uint8Array) - 5-bit data array to encode
- `encoding` (string) - Encoding type ('bech32' or 'bech32m')

**Returns:**
- `string` - Encoded Bech32 address

**Throws:**
- `Error` - If prefix is invalid
- `Error` - If data contains invalid 5-bit values
- `Error` - If resulting address length is invalid

#### `BECH32.decode(address, expectedHrp = null)`
Decodes a Bech32 or Bech32m address with automatic encoding detection.

**Parameters:**
- `address` (string) - Bech32 address to decode
- `expectedHrp` (string) - Expected human-readable prefix (optional validation)

**Returns:**
- Object with decoded information:
  - `hrp` (string) - Human-readable prefix
  - `data` (Array) - Decoded 5-bit data array (without checksum)
  - `encoding` (string) - Detected encoding ('bech32' or 'bech32m')
  - `address` (string) - Original address in lowercase

**Throws:**
- `Error` - If address format is invalid
- `Error` - If checksum validation fails
- `Error` - If witness version doesn't match encoding

#### `BECH32.isValidAddress(address)`
Validates a Bech32 address format and checksum.

**Parameters:**
- `address` (string) - Address to validate

**Returns:**
- `boolean` - True if valid, false otherwise

#### `BECH32.data_to_bech32(prefix, data, encoding = 'bech32')`
Converts hex data to a Bech32 address with proper segwit formatting.

**Parameters:**
- `prefix` (string) - Address prefix ("bc", "tb")
- `data` (string) - Hexadecimal data string
- `encoding` (string) - Encoding type ('bech32' or 'bech32m')

**Returns:**
- `string` - Bech32 encoded address

**Features:**
- Automatic witness version extraction
- Proper 5-bit conversion
- Format validation

### Validation Features

#### Encoding Rules
- **Bech32**: Used for witness version 0 (SegWit v0)
- **Bech32m**: Used for witness version 1+ (Taproot and future versions)
- **Automatic Detection**: Decoder tries both encodings and validates against witness version

#### Address Format Validation
- Mixed case detection and rejection
- Separator ('1') presence validation
- Character set validation (32-character Bech32 alphabet)
- Length limits (8-90 characters)
- Checksum verification

### Security Features

- **Comprehensive Validation** - Full BIP173/BIP350 compliance validation
- **Rate Limiting** - DoS protection with configurable limits (50 operations/second)
- **Input Sanitization** - Thorough input validation and bounds checking
- **Test Vector Compliance** - Validates against official BIP test vectors
- **Memory Safety** - Secure buffer handling and cleanup
- **Timing Attack Prevention** - Constant-time operations where applicable
- **Error Isolation** - Proper error handling without information leakage

### Test Vector Compliance

The implementation includes and validates against official test vectors:

#### Valid Bech32 Addresses
- `bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4` (mainnet P2WPKH)
- `tb1qrp33g0q5c5txsp9arysrx4k6zdkfs4nce4xj0gdcccefvpysxf3q0sL5k7` (testnet P2WSH)
- `bc1pw508d6qejxtdg4y5r3zarvary0c5xw7kw508d6qejxtdg4y5r3zarvary0c5xw7k7grplx` (version 1)

#### Valid Bech32m Addresses  
- `tb1p0xlxvlhemja6c4dqv22uapctqupfhlxm9h8z3k2e72q4k9hcz7vqzagq` (testnet Taproot)
- `bc1p0xlxvlhemja6c4dqv22uapctqupfhlxm9h8z3k2e72q4k9hcz7vq47Zagq` (mainnet Taproot)

### Error Codes

- `INVALID_HRP_FORMAT` - Human-readable prefix format error
- `INVALID_CHARACTER` - Invalid character in address
- `INVALID_CHECKSUM` - Checksum validation failed
- `MIXED_CASE_NOT_ALLOWED` - Mixed case characters detected
- `INVALID_V0_ENCODING` - Version 0 must use bech32
- `INVALID_V1_ENCODING` - Version 1+ must use bech32m
- `RATE_LIMIT_EXCEEDED` - Too many operations per second
- `ADDRESS_TOO_SHORT` - Address below minimum length
- `ADDRESS_TOO_LONG` - Address exceeds maximum length