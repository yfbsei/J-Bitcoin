<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/core/taproot/merkle-tree.js - J-Bitcoin - Bitcoin Wallet Library</title>
    
    <meta name="description" content="JavaScript/TypeScript Bitcoin wallet library with HD wallets, threshold signatures, and BIP compliance" />
    
        <meta name="keywords" content="bitcoin, btc, cryptocurrency, wallet, javascript, typescript, threshold signatures, bip32, bip39" />
        <meta name="keyword" content="bitcoin, btc, cryptocurrency, wallet, javascript, typescript, threshold signatures, bip32, bip39" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin" target="_blank" class="menu-item home-link" id="home-link" >ğŸ  Home</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin" target="_blank" class="menu-item github-link" id="github-link" >ğŸ“š GitHub</a></h2><h2><a href="https://www.npmjs.com/package/j-bitcoin" target="_blank" class="menu-item npm-link" id="npm-link" >ğŸ“¦ NPM</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin/tree/main/examples" target="_blank" class="menu-item examples-link" id="examples-link" >ğŸ”§ Examples</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin/blob/main/CHANGELOG.md" target="_blank" class="menu-item changelog-link" id="changelog-link" >ğŸ“Š Changelog</a></h2><h3>Global</h3><ul><li><a href="global.html#BIP_COMPLIANCE">BIP_COMPLIANCE</a></li><li><a href="global.html#FEATURES">FEATURES</a></li><li><a href="global.html#LIBRARY_INFO">LIBRARY_INFO</a></li><li><a href="global.html#NETWORKS">NETWORKS</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">src/core/taproot/merkle-tree.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Taproot merkle tree implementation for script path spending
 * @version 2.1.0
 * @author yfbsei
 * @license ISC
 */

import { createHash, timingSafeEqual, randomBytes } from 'node:crypto';

class MerkleTreeError extends Error {
  constructor(message, code, details = {}) {
    super(message);
    this.name = 'MerkleTreeError';
    this.code = code;
    this.details = details;
  }
}

const MERKLE_CONSTANTS = {
  HASH_SIZE: 32,
  MAX_TREE_DEPTH: 128,
  MAX_SCRIPT_SIZE: 10000,
  MAX_LEAVES: 2 ** 16,
  TAPLEAF_TAG: 'TapLeaf',
  TAPBRANCH_TAG: 'TapBranch',
  TAPTWEAK_TAG: 'TapTweak',
  DEFAULT_LEAF_VERSION: 0xc0
};

class TaggedHash {
  static create(tag, data) {
    const tagHash = createHash('sha256').update(tag).digest();
    const taggedData = Buffer.concat([tagHash, tagHash, data]);
    return createHash('sha256').update(taggedData).digest();
  }

  static createTapLeaf(leafVersion, script) {
    const data = Buffer.concat([
      Buffer.from([leafVersion]),
      Buffer.from([script.length]),
      script
    ]);
    return this.create(MERKLE_CONSTANTS.TAPLEAF_TAG, data);
  }

  static createTapBranch(left, right) {
    const ordered = Buffer.compare(left, right) &lt; 0
      ? Buffer.concat([left, right])
      : Buffer.concat([right, left]);
    return this.create(MERKLE_CONSTANTS.TAPBRANCH_TAG, ordered);
  }

  static createTapTweak(internalKey, merkleRoot = null) {
    const data = merkleRoot
      ? Buffer.concat([internalKey, merkleRoot])
      : internalKey;
    return this.create(MERKLE_CONSTANTS.TAPTWEAK_TAG, data);
  }
}

class TaprootMerkleTree {
  constructor(scripts, leafVersion = MERKLE_CONSTANTS.DEFAULT_LEAF_VERSION) {
    if (!Array.isArray(scripts) || scripts.length === 0) {
      throw new MerkleTreeError('Scripts array is required', 'INVALID_SCRIPTS');
    }

    if (scripts.length > MERKLE_CONSTANTS.MAX_LEAVES) {
      throw new MerkleTreeError('Too many scripts', 'TOO_MANY_LEAVES');
    }

    this.leafVersion = leafVersion;
    this.scripts = scripts;
    this.leaves = [];
    this.tree = [];

    this._buildTree();
  }

  _buildTree() {
    this.leaves = this.scripts.map((script, index) => ({
      script: Buffer.isBuffer(script) ? script : Buffer.from(script),
      leafVersion: this.leafVersion,
      hash: TaggedHash.createTapLeaf(
        this.leafVersion,
        Buffer.isBuffer(script) ? script : Buffer.from(script)
      ),
      index
    }));

    if (this.leaves.length === 1) {
      this.tree = [[this.leaves[0].hash]];
      this.root = this.leaves[0].hash;
      return;
    }

    let currentLevel = this.leaves.map(leaf => leaf.hash);
    this.tree = [currentLevel];

    while (currentLevel.length > 1) {
      const nextLevel = [];

      for (let i = 0; i &lt; currentLevel.length; i += 2) {
        if (i + 1 &lt; currentLevel.length) {
          const branch = TaggedHash.createTapBranch(currentLevel[i], currentLevel[i + 1]);
          nextLevel.push(branch);
        } else {
          nextLevel.push(currentLevel[i]);
        }
      }

      this.tree.push(nextLevel);
      currentLevel = nextLevel;
    }

    this.root = currentLevel[0];
  }

  getRoot() {
    return this.root;
  }

  getMerklePath(leafIndex) {
    if (leafIndex &lt; 0 || leafIndex >= this.leaves.length) {
      throw new MerkleTreeError('Invalid leaf index', 'INVALID_INDEX');
    }

    const path = [];
    let index = leafIndex;

    for (let level = 0; level &lt; this.tree.length - 1; level++) {
      const currentLevel = this.tree[level];
      const siblingIndex = index % 2 === 0 ? index + 1 : index - 1;

      if (siblingIndex &lt; currentLevel.length) {
        path.push({
          hash: currentLevel[siblingIndex],
          position: index % 2 === 0 ? 'right' : 'left'
        });
      }

      index = Math.floor(index / 2);
    }

    return {
      leafIndex,
      leafHash: this.leaves[leafIndex].hash,
      hashes: path.map(p => p.hash),
      positions: path.map(p => p.position)
    };
  }

  verifyInclusion(leafIndex, leafHash) {
    const path = this.getMerklePath(leafIndex);
    let computedHash = leafHash;

    for (let i = 0; i &lt; path.hashes.length; i++) {
      computedHash = TaggedHash.createTapBranch(computedHash, path.hashes[i]);
    }

    return computedHash.equals(this.root);
  }

  getLeaf(index) {
    if (index &lt; 0 || index >= this.leaves.length) {
      throw new MerkleTreeError('Invalid leaf index', 'INVALID_INDEX');
    }
    return { ...this.leaves[index] };
  }

  getLeafCount() {
    return this.leaves.length;
  }

  getTreeDepth() {
    return this.tree.length;
  }

  toJSON() {
    return {
      root: this.root.toString('hex'),
      leafVersion: this.leafVersion,
      leafCount: this.leaves.length,
      depth: this.tree.length,
      leaves: this.leaves.map(leaf => ({
        hash: leaf.hash.toString('hex'),
        index: leaf.index
      }))
    };
  }
}

export {
  TaprootMerkleTree,
  TaggedHash,
  MerkleTreeError,
  MERKLE_CONSTANTS
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Tue Dec 30 2025 14:53:38 GMT-0500 (Eastern Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
