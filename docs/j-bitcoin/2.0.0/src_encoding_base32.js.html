<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/encoding/base32.js - J-Bitcoin - Bitcoin Wallet Library</title>
    
    <meta name="description" content="JavaScript/TypeScript Bitcoin wallet library with HD wallets, threshold signatures, and BIP compliance" />
    
        <meta name="keywords" content="bitcoin, btc, cryptocurrency, wallet, javascript, typescript, threshold signatures, bip32, bip39" />
        <meta name="keyword" content="bitcoin, btc, cryptocurrency, wallet, javascript, typescript, threshold signatures, bip32, bip39" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin" target="_blank" class="menu-item home-link" id="home-link" >üè† Home</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin" target="_blank" class="menu-item github-link" id="github-link" >üìö GitHub</a></h2><h2><a href="https://www.npmjs.com/package/j-bitcoin" target="_blank" class="menu-item npm-link" id="npm-link" >üì¶ NPM</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin/tree/main/examples" target="_blank" class="menu-item examples-link" id="examples-link" >üîß Examples</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin/blob/main/CHANGELOG.md" target="_blank" class="menu-item changelog-link" id="changelog-link" >üìä Changelog</a></h2><h3>Global</h3><ul><li><a href="global.html#BIP_COMPLIANCE">BIP_COMPLIANCE</a></li><li><a href="global.html#FEATURES">FEATURES</a></li><li><a href="global.html#LIBRARY_INFO">LIBRARY_INFO</a></li><li><a href="global.html#NETWORKS">NETWORKS</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">src/encoding/base32.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Bech32/Bech32m encoding for Bitcoin SegWit and Taproot addresses
 * @version 2.1.0
 * @author yfbsei
 * @license ISC
 */

const CHARSET = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
const BECH32_CONST = 1;
const BECH32M_CONST = 0x2bc830a3;

const GENERATOR = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];

function polymod(values) {
  let chk = 1;
  for (const v of values) {
    const top = chk >> 25;
    chk = ((chk &amp; 0x1ffffff) &lt;&lt; 5) ^ v;
    for (let i = 0; i &lt; 5; i++) {
      if ((top >> i) &amp; 1) {
        chk ^= GENERATOR[i];
      }
    }
  }
  return chk;
}

function hrpExpand(hrp) {
  const result = [];
  for (let i = 0; i &lt; hrp.length; i++) {
    result.push(hrp.charCodeAt(i) >> 5);
  }
  result.push(0);
  for (let i = 0; i &lt; hrp.length; i++) {
    result.push(hrp.charCodeAt(i) &amp; 31);
  }
  return result;
}

function verifyChecksum(hrp, data, spec) {
  const constant = spec === 'bech32m' ? BECH32M_CONST : BECH32_CONST;
  return polymod(hrpExpand(hrp).concat(data)) === constant;
}

function createChecksum(hrp, data, spec) {
  const constant = spec === 'bech32m' ? BECH32M_CONST : BECH32_CONST;
  const values = hrpExpand(hrp).concat(data).concat([0, 0, 0, 0, 0, 0]);
  const mod = polymod(values) ^ constant;
  const result = [];
  for (let i = 0; i &lt; 6; i++) {
    result.push((mod >> (5 * (5 - i))) &amp; 31);
  }
  return result;
}

function encode(hrp, data, spec = 'bech32') {
  const checksum = createChecksum(hrp, data, spec);
  const combined = data.concat(checksum);
  let result = hrp + '1';
  for (const d of combined) {
    result += CHARSET[d];
  }
  return result;
}

function decode(str) {
  if (str.length &lt; 8 || str.length > 90) {
    throw new Error('Invalid bech32 string length');
  }

  const lowered = str.toLowerCase();
  const uppered = str.toUpperCase();

  if (str !== lowered &amp;&amp; str !== uppered) {
    throw new Error('Mixed case in bech32 string');
  }

  const bech = lowered;
  const pos = bech.lastIndexOf('1');

  if (pos &lt; 1 || pos + 7 > bech.length) {
    throw new Error('Invalid separator position');
  }

  const hrp = bech.slice(0, pos);
  const data = [];

  for (let i = pos + 1; i &lt; bech.length; i++) {
    const idx = CHARSET.indexOf(bech[i]);
    if (idx === -1) {
      throw new Error(`Invalid character: ${bech[i]}`);
    }
    data.push(idx);
  }

  let spec = 'bech32';
  if (!verifyChecksum(hrp, data, 'bech32')) {
    if (verifyChecksum(hrp, data, 'bech32m')) {
      spec = 'bech32m';
    } else {
      throw new Error('Invalid checksum');
    }
  }

  return { hrp, data: data.slice(0, -6), spec };
}

function convertBits(data, fromBits, toBits, pad = true) {
  let acc = 0;
  let bits = 0;
  const result = [];
  const maxv = (1 &lt;&lt; toBits) - 1;

  for (const value of data) {
    if (value &lt; 0 || value >> fromBits !== 0) {
      throw new Error('Invalid value for bit conversion');
    }
    acc = (acc &lt;&lt; fromBits) | value;
    bits += fromBits;
    while (bits >= toBits) {
      bits -= toBits;
      result.push((acc >> bits) &amp; maxv);
    }
  }

  if (pad) {
    if (bits > 0) {
      result.push((acc &lt;&lt; (toBits - bits)) &amp; maxv);
    }
  } else if (bits >= fromBits || ((acc &lt;&lt; (toBits - bits)) &amp; maxv) !== 0) {
    throw new Error('Invalid padding');
  }

  return result;
}

function encodeSegwit(hrp, version, program) {
  if (version &lt; 0 || version > 16) {
    throw new Error('Invalid witness version');
  }

  if (program.length &lt; 2 || program.length > 40) {
    throw new Error('Invalid witness program length');
  }

  if (version === 0 &amp;&amp; program.length !== 20 &amp;&amp; program.length !== 32) {
    throw new Error('Invalid witness program length for v0');
  }

  const spec = version === 0 ? 'bech32' : 'bech32m';
  const data = [version].concat(convertBits(Array.from(program), 8, 5));

  return encode(hrp, data, spec);
}

function decodeSegwit(hrp, addr) {
  const { hrp: decodedHrp, data, spec } = decode(addr);

  if (decodedHrp !== hrp) {
    throw new Error('HRP mismatch');
  }

  if (data.length &lt; 1) {
    throw new Error('Empty data');
  }

  const version = data[0];

  if (version > 16) {
    throw new Error('Invalid witness version');
  }

  if (version === 0 &amp;&amp; spec !== 'bech32') {
    throw new Error('Version 0 must use bech32');
  }

  if (version !== 0 &amp;&amp; spec !== 'bech32m') {
    throw new Error('Version 1+ must use bech32m');
  }

  const program = Buffer.from(convertBits(data.slice(1), 5, 8, false));

  if (program.length &lt; 2 || program.length > 40) {
    throw new Error('Invalid program length');
  }

  if (version === 0 &amp;&amp; program.length !== 20 &amp;&amp; program.length !== 32) {
    throw new Error('Invalid v0 program length');
  }

  return { version, program };
}

export {
  encode,
  decode,
  encodeSegwit,
  decodeSegwit,
  convertBits,
  CHARSET,
  BECH32_CONST,
  BECH32M_CONST
};

export default {
  encode,
  decode,
  encodeSegwit,
  decodeSegwit,
  convertBits
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Tue Dec 30 2025 14:53:38 GMT-0500 (Eastern Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
