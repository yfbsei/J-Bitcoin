<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/transaction/builder.js - J-Bitcoin - Bitcoin Wallet Library</title>
    
    <meta name="description" content="JavaScript/TypeScript Bitcoin wallet library with HD wallets, threshold signatures, and BIP compliance" />
    
        <meta name="keywords" content="bitcoin, btc, cryptocurrency, wallet, javascript, typescript, threshold signatures, bip32, bip39" />
        <meta name="keyword" content="bitcoin, btc, cryptocurrency, wallet, javascript, typescript, threshold signatures, bip32, bip39" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin" target="_blank" class="menu-item home-link" id="home-link" >üè† Home</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin" target="_blank" class="menu-item github-link" id="github-link" >üìö GitHub</a></h2><h2><a href="https://www.npmjs.com/package/j-bitcoin" target="_blank" class="menu-item npm-link" id="npm-link" >üì¶ NPM</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin/tree/main/examples" target="_blank" class="menu-item examples-link" id="examples-link" >üîß Examples</a></h2><h2><a href="https://github.com/yfbsei/J-Bitcoin/blob/main/CHANGELOG.md" target="_blank" class="menu-item changelog-link" id="changelog-link" >üìä Changelog</a></h2><h3>Global</h3><ul><li><a href="global.html#BIP_COMPLIANCE">BIP_COMPLIANCE</a></li><li><a href="global.html#FEATURES">FEATURES</a></li><li><a href="global.html#LIBRARY_INFO">LIBRARY_INFO</a></li><li><a href="global.html#NETWORKS">NETWORKS</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">src/transaction/builder.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Transaction builder with Taproot support
 * @version 2.1.0
 * @author yfbsei
 * @license ISC
 */

import { createHash } from 'node:crypto';
import { secp256k1 } from '@noble/curves/secp256k1';
import rmd160 from '../core/crypto/hash/ripemd160.js';
import { BECH32 } from '../bip/BIP173-BIP350.js';
import { NETWORK_VERSIONS, CRYPTO_CONSTANTS, TRANSACTION_CONSTANTS } from '../core/constants.js';
import { validateAddress, ValidationError } from '../utils/validation.js';
import { decodeAddress, getScriptPubKey } from '../utils/address-helpers.js';

class TransactionBuilderError extends Error {
  constructor(message, code, details = {}) {
    super(message);
    this.name = 'TransactionBuilderError';
    this.code = code;
    this.details = details;
  }
}

const TX_CONSTANTS = {
  VERSION: 2,
  DEFAULT_SEQUENCE: 0xffffffff,
  DEFAULT_LOCKTIME: 0,
  DUST_LIMIT: 546,
  SIGHASH_ALL: 0x01,
  SIGHASH_NONE: 0x02,
  SIGHASH_SINGLE: 0x03,
  SIGHASH_ANYONECANPAY: 0x80
};

class TransactionBuilder {
  constructor(network = 'main', options = {}) {
    this.network = network;
    this.version = options.version || TX_CONSTANTS.VERSION;
    this.locktime = options.locktime || TX_CONSTANTS.DEFAULT_LOCKTIME;
    this.inputs = [];
    this.outputs = [];
    this.witnesses = [];
  }

  addInput(input) {
    if (!input.txid || typeof input.txid !== 'string') {
      throw new TransactionBuilderError('Invalid txid', 'INVALID_TXID');
    }

    if (typeof input.vout !== 'number' || input.vout &lt; 0) {
      throw new TransactionBuilderError('Invalid vout', 'INVALID_VOUT');
    }

    this.inputs.push({
      txid: input.txid,
      vout: input.vout,
      sequence: input.sequence || TX_CONSTANTS.DEFAULT_SEQUENCE,
      value: input.value,
      scriptPubKey: input.scriptPubKey,
      address: input.address,
      addressType: input.addressType
    });

    return this;
  }

  addOutput(output) {
    if (!output.address &amp;&amp; !output.scriptPubKey) {
      throw new TransactionBuilderError('Address or scriptPubKey required', 'MISSING_OUTPUT');
    }

    if (typeof output.value !== 'number' || output.value &lt; 0) {
      throw new TransactionBuilderError('Invalid output value', 'INVALID_VALUE');
    }

    if (output.value &lt; TX_CONSTANTS.DUST_LIMIT &amp;&amp; output.value !== 0) {
      throw new TransactionBuilderError('Output below dust limit', 'DUST_OUTPUT');
    }

    let scriptPubKey = output.scriptPubKey;
    if (!scriptPubKey &amp;&amp; output.address) {
      scriptPubKey = getScriptPubKey(output.address);
    }

    this.outputs.push({
      value: output.value,
      scriptPubKey,
      address: output.address
    });

    return this;
  }

  setLocktime(locktime) {
    this.locktime = locktime;
    return this;
  }

  setVersion(version) {
    this.version = version;
    return this;
  }

  build() {
    if (this.inputs.length === 0) {
      throw new TransactionBuilderError('No inputs added', 'NO_INPUTS');
    }

    if (this.outputs.length === 0) {
      throw new TransactionBuilderError('No outputs added', 'NO_OUTPUTS');
    }

    return {
      version: this.version,
      inputs: this.inputs.map(input => ({
        txid: input.txid,
        vout: input.vout,
        sequence: input.sequence,
        scriptSig: Buffer.alloc(0)
      })),
      outputs: this.outputs.map(output => ({
        value: output.value,
        scriptPubKey: output.scriptPubKey
      })),
      locktime: this.locktime,
      witnesses: this.witnesses
    };
  }

  serialize(transaction = null) {
    const tx = transaction || this.build();
    const parts = [];

    const version = Buffer.alloc(4);
    version.writeUInt32LE(tx.version, 0);
    parts.push(version);

    const hasWitness = tx.witnesses &amp;&amp; tx.witnesses.length > 0;
    if (hasWitness) {
      parts.push(Buffer.from([0x00, 0x01]));
    }

    parts.push(this._encodeVarInt(tx.inputs.length));

    for (const input of tx.inputs) {
      const txidBuffer = Buffer.from(input.txid, 'hex').reverse();
      parts.push(txidBuffer);

      const vout = Buffer.alloc(4);
      vout.writeUInt32LE(input.vout, 0);
      parts.push(vout);

      const scriptSig = input.scriptSig || Buffer.alloc(0);
      parts.push(this._encodeVarInt(scriptSig.length));
      parts.push(scriptSig);

      const sequence = Buffer.alloc(4);
      sequence.writeUInt32LE(input.sequence, 0);
      parts.push(sequence);
    }

    parts.push(this._encodeVarInt(tx.outputs.length));

    for (const output of tx.outputs) {
      const value = Buffer.alloc(8);
      value.writeBigUInt64LE(BigInt(output.value), 0);
      parts.push(value);

      const script = output.scriptPubKey;
      parts.push(this._encodeVarInt(script.length));
      parts.push(script);
    }

    if (hasWitness) {
      for (const witness of tx.witnesses) {
        parts.push(this._encodeVarInt(witness.length));
        for (const item of witness) {
          parts.push(this._encodeVarInt(item.length));
          parts.push(item);
        }
      }
    }

    const locktime = Buffer.alloc(4);
    locktime.writeUInt32LE(tx.locktime, 0);
    parts.push(locktime);

    return Buffer.concat(parts);
  }

  getTxid(transaction = null) {
    const tx = transaction || this.build();
    const txCopy = { ...tx, witnesses: [] };

    const serialized = this.serialize(txCopy);
    const hash = createHash('sha256')
      .update(createHash('sha256').update(serialized).digest())
      .digest();

    return hash.reverse().toString('hex');
  }

  calculateFee(feeRate = 1) {
    const virtualSize = this.getVirtualSize();
    return Math.ceil(virtualSize * feeRate);
  }

  getVirtualSize() {
    const tx = this.build();
    const baseSerialized = this.serialize({ ...tx, witnesses: [] });
    const baseSize = baseSerialized.length;

    if (!tx.witnesses || tx.witnesses.length === 0) {
      return baseSize;
    }

    const fullSerialized = this.serialize(tx);
    const witnessSize = fullSerialized.length - baseSize;

    return Math.ceil(baseSize * 3 + fullSerialized.length) / 4;
  }

  _encodeVarInt(n) {
    if (n &lt; 0xfd) {
      return Buffer.from([n]);
    } else if (n &lt;= 0xffff) {
      const buf = Buffer.alloc(3);
      buf[0] = 0xfd;
      buf.writeUInt16LE(n, 1);
      return buf;
    } else if (n &lt;= 0xffffffff) {
      const buf = Buffer.alloc(5);
      buf[0] = 0xfe;
      buf.writeUInt32LE(n, 1);
      return buf;
    } else {
      const buf = Buffer.alloc(9);
      buf[0] = 0xff;
      buf.writeBigUInt64LE(BigInt(n), 1);
      return buf;
    }
  }

  clone() {
    const builder = new TransactionBuilder(this.network, {
      version: this.version,
      locktime: this.locktime
    });

    builder.inputs = [...this.inputs];
    builder.outputs = [...this.outputs];
    builder.witnesses = [...this.witnesses];

    return builder;
  }

  reset() {
    this.inputs = [];
    this.outputs = [];
    this.witnesses = [];
    this.locktime = TX_CONSTANTS.DEFAULT_LOCKTIME;
    return this;
  }
}

export {
  TransactionBuilder,
  TransactionBuilderError,
  TX_CONSTANTS
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Tue Dec 30 2025 14:53:38 GMT-0500 (Eastern Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
